"""
monitor_logger.py
Script simples para receber as mensagens MQTT de 'saude/camila/data' e gravar em arquivo CSV.
Também permite enviar comandos ao tópico 'saude/camila/commands' (ex.: acionar buzzer ou LED).

Dependências:
  pip install paho-mqtt
"""

import paho.mqtt.client as mqtt
import json
import csv
import time
from datetime import datetime

BROKER = "broker.hivemq.com"  # exemplo
PORT = 1883
TOPIC_DATA = "saude/camila/data"
TOPIC_ALERT = "saude/camila/alertas"
TOPIC_CMD = "saude/camila/commands"

csvfile = "dados_monitor.csv"
header_written = False

def on_connect(client, userdata, flags, rc):
    print("Conectado com codigo:", rc)
    client.subscribe(TOPIC_DATA)
    client.subscribe(TOPIC_ALERT)

def on_message(client, userdata, msg):
    global header_written
    try:
        payload = msg.payload.decode()
        print(f"[{msg.topic}] {payload}")
        if msg.topic == TOPIC_DATA:
            data = json.loads(payload)
            # grava em CSV
            with open(csvfile, "a", newline='') as f:
                writer = csv.writer(f)
                if not header_written:
                    writer.writerow(["ts","bpm","spo2","temp","steps"])
                    header_written = True
                ts = datetime.now().isoformat()
                writer.writerow([ts, data.get("bpm"), data.get("spo2"), data.get("temp"), data.get("steps")])
    except Exception as e:
        print("Erro ao tratar mensagem:", e)

def send_command(client, cmd_json):
    client.publish(TOPIC_CMD, json.dumps(cmd_json))
    print("Comando enviado:", cmd_json)

def main():
    client = mqtt.Client()
    client.on_connect = on_connect
    client.on_message = on_message
    client.connect(BROKER, PORT, 60)
    client.loop_start()
    print("Logger ativo. Ctrl-C para sair.")
    try:
        while True:
            cmd = input("Digite comando (buzz X / led green/red/blue / sair): ")
            if cmd.startswith("buzz"):
                parts = cmd.split()
                dur = 300
                if len(parts) >= 2:
                    dur = int(parts[1])
                send_command(client, {"cmd":"buzz","dur":dur})
            elif cmd.startswith("led"):
                parts = cmd.split()
                if len(parts) >= 2:
                    color = parts[1]
                    send_command(client, {"cmd":"led","color":color})
            elif cmd == "sair":
                break
            else:
                print("Comando desconhecido.")
    except KeyboardInterrupt:
        pass
    finally:
        client.loop_stop()
        client.disconnect()

if __name__ == "__main__":
    main()
